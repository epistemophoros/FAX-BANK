# Pull Request Check Workflow
# Runs additional checks on PRs to main branch

name: PR Check

on:
  pull_request:
    branches:
      - main
    types:
      - opened
      - synchronize
      - reopened

jobs:
  pr-validation:
    name: PR Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check PR title format
        run: |
          TITLE="${{ github.event.pull_request.title }}"
          
          # Check for conventional commit format
          if [[ ! "$TITLE" =~ ^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\(.+\))?: ]]; then
            echo "::warning::PR title should follow conventional commit format"
            echo "Examples: feat: add new feature, fix(ui): resolve button issue"
          else
            echo "PR title format is valid!"
          fi

      - name: Check for version bump
        run: |
          # Get version from main branch
          git fetch origin main
          MAIN_VERSION=$(git show origin/main:package.json | node -p "JSON.parse(require('fs').readFileSync('/dev/stdin', 'utf8')).version")
          
          # Get version from PR branch
          PR_VERSION=$(node -p "require('./package.json').version")
          
          echo "Main branch version: $MAIN_VERSION"
          echo "PR branch version: $PR_VERSION"
          
          if [ "$MAIN_VERSION" == "$PR_VERSION" ]; then
            echo "::notice::Consider bumping the version number if this PR includes new features or fixes"
          else
            echo "Version has been updated from $MAIN_VERSION to $PR_VERSION"
          fi

      - name: Check for CHANGELOG update
        run: |
          if [ -f CHANGELOG.md ]; then
            # Check if CHANGELOG was modified
            git diff --name-only origin/main...HEAD | grep -q "CHANGELOG.md" && {
              echo "CHANGELOG.md has been updated!"
            } || {
              echo "::notice::Consider updating CHANGELOG.md with your changes"
            }
          else
            echo "::notice::No CHANGELOG.md found. Consider adding one."
          fi

  size-check:
    name: Bundle Size Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build and check size
        run: |
          npm run build
          
          # Check bundle size
          BUNDLE_SIZE=$(wc -c < dist/scripts/module.js)
          BUNDLE_SIZE_KB=$((BUNDLE_SIZE / 1024))
          
          echo "Bundle size: ${BUNDLE_SIZE_KB}KB"
          
          # Warn if bundle is larger than 500KB
          if [ $BUNDLE_SIZE_KB -gt 500 ]; then
            echo "::warning::Bundle size is ${BUNDLE_SIZE_KB}KB. Consider optimizing."
          else
            echo "Bundle size is acceptable."
          fi
          
          echo "## Bundle Size Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Total Size:** ${BUNDLE_SIZE_KB}KB" >> $GITHUB_STEP_SUMMARY

