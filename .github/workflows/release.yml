# Release Workflow
# Creates releases for both development (pre-release) and main (stable)

name: Release

on:
  push:
    branches:
      - main
      - development
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  # Run CI checks first
  ci:
    name: CI Checks
    uses: ./.github/workflows/ci.yml

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: ci
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Get version from package.json
        id: package_version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Determine release type
        id: release_type
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]] || [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            echo "type=stable" >> $GITHUB_OUTPUT
            echo "prerelease=false" >> $GITHUB_OUTPUT
            echo "version=${{ steps.package_version.outputs.version }}" >> $GITHUB_OUTPUT
            echo "tag=v${{ steps.package_version.outputs.version }}" >> $GITHUB_OUTPUT
          else
            # Development release
            SHORT_SHA=$(git rev-parse --short HEAD)
            DEV_VERSION="${{ steps.package_version.outputs.version }}-dev.${SHORT_SHA}"
            echo "type=development" >> $GITHUB_OUTPUT
            echo "prerelease=true" >> $GITHUB_OUTPUT
            echo "version=$DEV_VERSION" >> $GITHUB_OUTPUT
            echo "tag=v$DEV_VERSION" >> $GITHUB_OUTPUT
          fi

      - name: Build module
        run: npm run build

      - name: Prepare release files
        run: |
          mkdir -p release/example-module

          # Copy built files
          cp -r dist/* release/example-module/

          # Copy static files
          cp module.json release/example-module/
          cp -r templates release/example-module/
          cp -r languages release/example-module/
          cp README.md release/example-module/ 2>/dev/null || true
          cp LICENSE release/example-module/ 2>/dev/null || true
          cp CHANGELOG.md release/example-module/ 2>/dev/null || true

      - name: Update module.json for release
        run: |
          VERSION="${{ steps.release_type.outputs.version }}"
          TAG="${{ steps.release_type.outputs.tag }}"
          TYPE="${{ steps.release_type.outputs.type }}"
          
          if [ "$TYPE" == "stable" ]; then
            MANIFEST_URL="https://github.com/${{ github.repository }}/releases/latest/download/module.json"
            DOWNLOAD_URL="https://github.com/${{ github.repository }}/releases/download/${TAG}/module.zip"
          else
            MANIFEST_URL="https://github.com/${{ github.repository }}/releases/download/${TAG}/module.json"
            DOWNLOAD_URL="https://github.com/${{ github.repository }}/releases/download/${TAG}/module.zip"
          fi
          
          sed -i "s|#{VERSION}#|$VERSION|g" release/example-module/module.json
          sed -i "s|#{MANIFEST_URL}#|$MANIFEST_URL|g" release/example-module/module.json
          sed -i "s|#{DOWNLOAD_URL}#|$DOWNLOAD_URL|g" release/example-module/module.json
          
          echo "Updated module.json:"
          cat release/example-module/module.json

      - name: Create module archive
        run: |
          cd release
          zip -r module.zip example-module
          mv module.zip ../
          cd ..

      - name: Copy module.json for release
        run: cp release/example-module/module.json ./module-release.json

      - name: Generate changelog
        id: changelog
        run: |
          if [ -f CHANGELOG.md ]; then
            CHANGELOG=$(sed -n '/^## \[/,/^## \[/p' CHANGELOG.md | sed '$d' | tail -n +2)
          else
            CHANGELOG="Release ${{ steps.release_type.outputs.version }}"
          fi
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Delete existing tag (for dev releases)
        if: steps.release_type.outputs.type == 'development'
        run: |
          git push origin :refs/tags/${{ steps.release_type.outputs.tag }} 2>/dev/null || true
        continue-on-error: true

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.release_type.outputs.tag }}
          name: ${{ steps.release_type.outputs.type == 'stable' && format('Release {0}', steps.release_type.outputs.version) || format('Development Build {0}', steps.release_type.outputs.version) }}
          body: |
            ## Example Module ${{ steps.release_type.outputs.version }}
            
            ${{ steps.release_type.outputs.type == 'development' && '⚠️ **This is a development build.** It may be unstable.' || '' }}
            
            ${{ steps.changelog.outputs.changelog }}
            
            ### Installation
            
            **Manifest URL (${{ steps.release_type.outputs.type }}):**
            ```
            https://github.com/${{ github.repository }}/releases/download/${{ steps.release_type.outputs.tag }}/module.json
            ```
            
            ${{ steps.release_type.outputs.type == 'stable' && '**Latest Stable Manifest:**' || '' }}
            ${{ steps.release_type.outputs.type == 'stable' && '```' || '' }}
            ${{ steps.release_type.outputs.type == 'stable' && format('https://github.com/{0}/releases/latest/download/module.json', github.repository) || '' }}
            ${{ steps.release_type.outputs.type == 'stable' && '```' || '' }}
            
            **Manual Installation:**
            1. Download `module.zip` from this release
            2. Extract to your Foundry VTT `Data/modules/` directory
            3. Restart Foundry VTT
            4. Enable the module in your world
          files: |
            module.zip
            module-release.json
          draft: false
          prerelease: ${{ steps.release_type.outputs.prerelease }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          echo "## Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Type:** ${{ steps.release_type.outputs.type }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${{ steps.release_type.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag:** ${{ steps.release_type.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Pre-release:** ${{ steps.release_type.outputs.prerelease }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Manifest URLs" >> $GITHUB_STEP_SUMMARY
          echo "- This release: \`https://github.com/${{ github.repository }}/releases/download/${{ steps.release_type.outputs.tag }}/module.json\`" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.release_type.outputs.type }}" == "stable" ]; then
            echo "- Latest stable: \`https://github.com/${{ github.repository }}/releases/latest/download/module.json\`" >> $GITHUB_STEP_SUMMARY
          fi
